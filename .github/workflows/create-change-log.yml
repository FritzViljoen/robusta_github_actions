name: Create Change Log

on:
  workflow_dispatch:
    inputs:
      target_branch:
        type: choice
        description: "target branch"
        options:
          - next-eu
          - staging-na
          - prod-na
          - prod-eu
      slack_channel:
        type: string
        description: "slack channel name or id"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      prerelease_branches: (next-eu, staging-na)
      target_branch: ${{ github.event.inputs.target_branch }}
      version_bump: ${{ github.event.inputs.version_bump }}

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: '0'

      - name: Set source branch
        run: |
          case ${{ env.target_branch }} in
            next-eu)    echo "source_branch=edge" >> $GITHUB_ENV;;
            staging-na) echo "source_branch=next-eu" >> $GITHUB_ENV;;
            *)          echo "source_branch=staging-na" >> $GITHUB_ENV;;
          esac

      #          output=$(ruby ./script/create-github-pr ${{ env.target_branch }} ${{ env.source_branch }})
      #          output="${output//'%'/'%25'}"
      #          output="${output//$'\n'/'%0A'}"
      #          output="${output//$'\r'/'%0D'}"
      #          echo "::set-output name=pr_body::$output"

      - name: Compile change log
        id: compile_pr
        run: |
          curl -X POST -H 'Content-type: application/json' --data 
            {
              "text": "Danny Torrence left a 1 star review for your property.",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Danny Torrence left the following review for your property:"
                  }
                },
                {
                  "type": "section",
                  "block_id": "section567",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<https://example.com|Overlook Hotel> \n :star: \n Doors had too many axe holes, guest in room 237 was far too rowdy, whole place felt stuck in the 1920s."
                  },
                  "accessory": {
                    "type": "image",
                    "image_url": "https://is5-ssl.mzstatic.com/image/thumb/Purple3/v4/d3/72/5c/d3725c8f-c642-5d69-1904-aa36e4297885/source/256x256bb.jpg",
                    "alt_text": "Haunted hotel image"
                  }
                },
                {
                  "type": "section",
                  "block_id": "section789",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Average Rating*\n1.0"
                    }
                  ]
                }
              ]
            }
          https://hooks.slack.com/services/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
#      - name: Post PR Body to a slack channel
#        uses: slackapi/slack-github-action@v1.16.0
#        with:
#          channel-id: ${{ github.event.inputs.slack_channel }}
#          slack-message: ${{ steps.compile_pr.outputs.pr_body }}"
#        env:
#          SLACK_BOT_TOKEN: ${{ secrets.SLACK_TOKEN }}
